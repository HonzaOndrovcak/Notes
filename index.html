<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pozn√°mky</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #212121;
            color: #e0e0e0;
            height: 100vh;
            overflow: hidden;
            transition: background 0.3s, color 0.3s;
        }

        body.light-mode {
            background: #ffffff;
            color: #1a1a1a;
        }

        body.light-mode .sidebar {
            background: #f5f5f5;
            border-right-color: #e0e0e0;
        }

        body.light-mode .sidebar-header {
            border-bottom-color: #e0e0e0;
        }

        body.light-mode .btn {
            border-color: #d0d0d0;
            color: #1a1a1a;
        }

        body.light-mode .btn:hover {
            background: #e8e8e8;
        }

        body.light-mode .btn-primary {
            background: #e8e8e8;
        }

        body.light-mode .search-box {
            background: #ffffff;
            border-color: #d0d0d0;
            color: #1a1a1a;
        }

        body.light-mode .search-box::placeholder {
            color: #999;
        }

        body.light-mode .nav-title {
            color: #666;
        }

        body.light-mode .nav-item {
            color: #1a1a1a;
        }

        body.light-mode .nav-item:hover {
            background: #e8e8e8;
            color: #1a1a1a;
        }

        body.light-mode .nav-item.active {
            background: #e8e8e8;
            color: #1a1a1a;
        }

        body.light-mode .content-header {
            border-bottom-color: #e0e0e0;
        }

        body.light-mode .note-title,
        body.light-mode .note-content {
            color: #1a1a1a;
        }

        body.light-mode .note-title::placeholder,
        body.light-mode .note-content::placeholder {
            color: #999;
        }

        body.light-mode .empty-state {
            color: #999;
        }

        body.light-mode .toggle-sidebar-btn {
            background: #e8e8e8;
            border-color: #d0d0d0;
            color: #1a1a1a;
        }

        body.light-mode .toggle-sidebar-btn:hover {
            background: #d8d8d8;
        }

        body.light-mode .editor-toolbar {
            border-bottom-color: #e0e0e0;
        }

        body.light-mode .toolbar-btn,
        body.light-mode .font-size-selector {
            background: #e8e8e8;
            border-color: #d0d0d0;
            color: #1a1a1a;
        }

        body.light-mode .toolbar-btn:hover {
            background: #d8d8d8;
        }

        body.light-mode .toolbar-btn.active {
            background: #667eea;
            border-color: #667eea;
            color: white;
        }

        body.light-mode .modal {
            background: rgba(0, 0, 0, 0.4);
        }

        body.light-mode .modal-content {
            background: #ffffff;
            color: #1a1a1a;
        }

        body.light-mode .modal-content input,
        body.light-mode .modal-content select {
            background: #f5f5f5;
            border-color: #d0d0d0;
            color: #1a1a1a;
        }

        body.light-mode .btn-cancel {
            border-color: #d0d0d0;
            color: #1a1a1a;
        }

        body.light-mode ::-webkit-scrollbar-track {
            background: #f5f5f5;
        }

        body.light-mode ::-webkit-scrollbar-thumb {
            background: #d0d0d0;
        }

        body.light-mode ::-webkit-scrollbar-thumb:hover {
            background: #c0c0c0;
        }

        .sync-status {
            position: fixed;
            bottom: 16px;
            right: 16px;
            padding: 8px 16px;
            background: #2a2a2a;
            border: 1px solid #3a3a3a;
            border-radius: 6px;
            color: #e0e0e0;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
            z-index: 100;
        }

        .sync-status.syncing {
            border-color: #667eea;
        }

        .sync-status.error {
            border-color: #f44336;
            background: #2a1a1a;
        }

        body.light-mode .sync-status {
            background: #f5f5f5;
            border-color: #d0d0d0;
            color: #1a1a1a;
        }

        .container {
            display: flex;
            height: 100vh;
        }

        .sidebar {
            width: 280px;
            background: #171717;
            border-right: 1px solid #2a2a2a;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            transition: margin-left 0.3s;
        }

        .sidebar.collapsed {
            margin-left: -280px;
        }

        .toggle-sidebar-btn {
            position: fixed;
            left: 280px;
            top: 16px;
            width: 32px;
            height: 32px;
            background: #2a2a2a;
            border: 1px solid #3a3a3a;
            border-radius: 6px;
            color: #e0e0e0;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
            transition: left 0.3s;
        }

        .toggle-sidebar-btn.collapsed {
            left: 16px;
        }

        .toggle-sidebar-btn:hover {
            background: #3a3a3a;
        }

        .theme-toggle-btn {
            position: fixed;
            left: 328px;
            top: 16px;
            width: 32px;
            height: 32px;
            background: #2a2a2a;
            border: 1px solid #3a3a3a;
            border-radius: 6px;
            color: #e0e0e0;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
            transition: left 0.3s;
        }

        .theme-toggle-btn.collapsed {
            left: 64px;
        }

        .theme-toggle-btn:hover {
            background: #3a3a3a;
        }

        .sidebar-header {
            padding: 16px;
            border-bottom: 1px solid #2a2a2a;
        }

        .logo {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .btn {
            width: 100%;
            padding: 12px 16px;
            background: transparent;
            border: 1px solid #3a3a3a;
            border-radius: 8px;
            color: #e0e0e0;
            cursor: pointer;
            font-size: 14px;
            text-align: left;
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
            transition: all 0.2s;
        }

        .btn:hover {
            background: #2a2a2a;
        }

        .btn-primary {
            background: #2a2a2a;
            border-color: #3a3a3a;
        }

        .search-box {
            width: 100%;
            padding: 10px 16px;
            background: #212121;
            border: 1px solid #3a3a3a;
            border-radius: 8px;
            color: #e0e0e0;
            font-size: 14px;
        }

        .search-box::placeholder {
            color: #666;
        }

        .nav-section {
            padding: 8px;
        }

        .nav-title {
            padding: 8px 16px;
            font-size: 12px;
            color: #888;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .nav-item {
            padding: 10px 16px;
            color: #e0e0e0;
            cursor: pointer;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: all 0.2s;
            margin-bottom: 2px;
        }

        .nav-item:hover {
            background: #2a2a2a;
            color: #e0e0e0;
        }

        .nav-item.active {
            background: #2a2a2a;
            color: #e0e0e0;
        }

        .nav-item.project {
            padding-left: 32px;
            font-size: 13px;
        }

        .nav-item .delete-btn {
            opacity: 0;
            background: #d32f2f;
            border: none;
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            cursor: pointer;
        }

        .nav-item:hover .delete-btn {
            opacity: 1;
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .content-header {
            padding: 16px 32px;
            border-bottom: 1px solid #2a2a2a;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .content-header h1 {
            font-size: 20px;
            font-weight: 600;
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
        }

        .export-btn {
            padding: 8px 16px;
            background: #667eea;
            border: none;
            border-radius: 6px;
            color: white;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
            position: absolute;
            right: 32px;
        }

        .export-btn:hover {
            background: #5568d3;
        }

        .content-body {
            flex: 1;
            overflow-y: auto;
            padding: 32px;
        }

        .editor {
            max-width: 900px;
            margin: 0 auto;
        }

        .editor-toolbar {
            display: flex;
            gap: 8px;
            padding: 12px 0;
            border-bottom: 1px solid #2a2a2a;
            margin-bottom: 20px;
        }

        .toolbar-btn {
            padding: 8px 12px;
            background: #2a2a2a;
            border: 1px solid #3a3a3a;
            border-radius: 6px;
            color: #e0e0e0;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }

        .toolbar-btn:hover {
            background: #3a3a3a;
        }

        .toolbar-btn.active {
            background: #667eea;
            border-color: #667eea;
        }

        .font-size-selector {
            padding: 8px 12px;
            background: #2a2a2a;
            border: 1px solid #3a3a3a;
            border-radius: 6px;
            color: #e0e0e0;
            cursor: pointer;
            font-size: 14px;
        }

        .note-title {
            width: 100%;
            padding: 12px 0;
            background: transparent;
            border: none;
            color: #e0e0e0;
            font-size: 28px;
            font-weight: 600;
            margin-bottom: 20px;
            outline: none;
        }

        .note-content {
            width: 100%;
            min-height: 400px;
            padding: 12px 0;
            background: transparent;
            border: none;
            color: #e0e0e0;
            font-size: 16px;
            line-height: 1.6;
            outline: none;
            font-family: inherit;
            white-space: pre-wrap;
        }

        .note-content img {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            margin: 12px 0;
        }

        .image-upload {
            display: none;
        }

        .note-title::placeholder,
        .note-content::placeholder {
            color: #555;
        }

        .empty-state {
            text-align: center;
            padding: 100px 20px;
            color: #666;
        }

        .empty-state h2 {
            font-size: 24px;
            margin-bottom: 12px;
        }

        .empty-state p {
            font-size: 16px;
        }

        .icon {
            width: 18px;
            height: 18px;
            fill: currentColor;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: #2a2a2a;
            padding: 24px;
            border-radius: 12px;
            width: 400px;
            max-width: 90%;
        }

        .modal-content h3 {
            margin-bottom: 16px;
            font-size: 18px;
        }

        .modal-content input {
            width: 100%;
            padding: 12px;
            background: #212121;
            border: 1px solid #3a3a3a;
            border-radius: 8px;
            color: #e0e0e0;
            font-size: 14px;
            margin-bottom: 16px;
        }

        .modal-content select {
            width: 100%;
            padding: 12px;
            background: #212121;
            border: 1px solid #3a3a3a;
            border-radius: 8px;
            color: #e0e0e0;
            font-size: 14px;
            margin-bottom: 16px;
            cursor: pointer;
        }

        .modal-content select option {
            background: #212121;
            color: #e0e0e0;
        }

        .modal-buttons {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        .modal-buttons button {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
        }

        .btn-cancel {
            background: transparent;
            color: #e0e0e0;
            border: 1px solid #3a3a3a;
        }

        .btn-create {
            background: #667eea;
            color: white;
        }

        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #171717;
        }

        ::-webkit-scrollbar-thumb {
            background: #3a3a3a;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #4a4a4a;
        }
    </style>
</head>
<body>
    <button class="toggle-sidebar-btn" id="toggleSidebarBtn" onclick="toggleSidebar()">‚ò∞</button>
    <button class="theme-toggle-btn" id="themeToggleBtn" onclick="toggleTheme()">üåô</button>
    
    <div class="container">
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="logo"></div>
                <button class="btn btn-primary" onclick="showNewNoteModal()">
                    <span>‚úèÔ∏è</span>
                    Nov√° pozn√°mka
                </button>
                <button class="btn" onclick="showNewProjectModal()">
                    <span>üìÅ</span>
                    Nov√Ω projekt
                </button>
                <input type="text" class="search-box" placeholder="Hledat pozn√°mky..." oninput="searchNotes(this.value)">
            </div>

            <div class="nav-section">
                <div class="nav-title">Pozn√°mky</div>
                <div id="notesList"></div>
            </div>

            <div class="nav-section">
                <div class="nav-title">Projekty</div>
                <div id="projectsList"></div>
            </div>
        </div>

        <div class="main-content">
            <div class="content-header">
                <h1 id="contentTitle">Vyberte pozn√°mku</h1>
                <button class="export-btn" id="exportBtn" style="display: none;" onclick="exportToPDF()">üì• Exportovat do PDF</button>
            </div>
            <div class="content-body">
                <div id="emptyState" class="empty-state">
                    <h2>≈Ω√°dn√° pozn√°mka nen√≠ vybr√°na</h2>
                    <p>Vyberte pozn√°mku ze seznamu nebo vytvo≈ôte novou</p>
                </div>
                <div id="editor" class="editor" style="display: none;">
                    <div class="editor-toolbar">
                        <button class="toolbar-btn" onclick="toggleBold()" title="Tuƒçn√© (Ctrl+B)"><strong>B</strong></button>
                        <button class="toolbar-btn" onclick="toggleItalic()" title="Kurz√≠va (Ctrl+I)"><em>I</em></button>
                        <button class="toolbar-btn" onclick="toggleUnderline()" title="Podtr≈æen√© (Ctrl+U)"><u>U</u></button>
                        <select class="font-size-selector" onchange="changeFontSize(this.value)">
                            <option value="14">Mal√©</option>
                            <option value="16" selected>Norm√°ln√≠</option>
                            <option value="18">St≈ôedn√≠</option>
                            <option value="20">Velk√©</option>
                            <option value="24">Extra velk√©</option>
                        </select>
                        <button class="toolbar-btn" onclick="document.getElementById('imageUpload').click()" title="Vlo≈æit obr√°zek">üñºÔ∏è</button>
                    </div>
                    <input type="file" id="imageUpload" class="image-upload" accept="image/*" onchange="insertImage(event)">
                    <input type="text" class="note-title" id="noteTitle" placeholder="N√°zev pozn√°mky">
                    <div class="note-content" id="noteContent" contenteditable="true" data-placeholder="Zaƒçnƒõte ps√°t..."></div>
                </div>
            </div>
        </div>
    </div>

    <div class="sync-status" id="syncStatus">
        <span id="syncIcon">‚òÅÔ∏è</span>
        <span id="syncText">P≈ôipojeno k Firebase</span>
    </div>

    <div class="modal" id="newNoteModal">
        <div class="modal-content">
            <h3>Nov√° pozn√°mka</h3>
            <input type="text" id="newNoteName" placeholder="N√°zev pozn√°mky">
            <select id="newNoteProject">
                <option value="">≈Ω√°dn√Ω projekt (voln√° pozn√°mka)</option>
            </select>
            <div class="modal-buttons">
                <button class="btn-cancel" onclick="closeModal('newNoteModal')">Zru≈°it</button>
                <button class="btn-create" onclick="createNote()">Vytvo≈ôit</button>
            </div>
        </div>
    </div>

    <div class="modal" id="newProjectModal">
        <div class="modal-content">
            <h3>Nov√Ω projekt</h3>
            <input type="text" id="newProjectName" placeholder="N√°zev projektu">
            <div class="modal-buttons">
                <button class="btn-cancel" onclick="closeModal('newProjectModal')">Zru≈°it</button>
                <button class="btn-create" onclick="createProject()">Vytvo≈ôit</button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, getDocs, onSnapshot } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // Firebase konfigurace
        const firebaseConfig = {
            apiKey: "AIzaSyCnFTrCye6Zm9ytObxhdXRAwP5rAYg_MvU",
            authDomain: "notes-cb1f3.firebaseapp.com",
            projectId: "notes-cb1f3",
            storageBucket: "notes-cb1f3.firebasestorage.app",
            messagingSenderId: "909427422578",
            appId: "1:909427422578:web:363ab4cf19e439eb2159eb",
            measurementId: "G-3G3KWP4DCQ"
        };

        // Inicializace Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        window.db = db;
        window.firestoreModules = { collection, addDoc, updateDoc, deleteDoc, doc, getDocs, onSnapshot };
        
        setSyncStatus('‚úÖ', 'P≈ôipojeno k Firebase', false);
    </script>
    
    <script>
        let notes = [];
        let projects = [];
        let currentNote = null;
        let saveTimeout = null;
        let isLoadingFromFirebase = false;

        function setSyncStatus(icon, text, isError = false) {
            const statusEl = document.getElementById('syncStatus');
            const iconEl = document.getElementById('syncIcon');
            const textEl = document.getElementById('syncText');
            
            iconEl.textContent = icon;
            textEl.textContent = text;
            
            if (isError) {
                statusEl.classList.add('error');
                statusEl.classList.remove('syncing');
            } else if (icon === 'üîÑ') {
                statusEl.classList.add('syncing');
                statusEl.classList.remove('error');
            } else {
                statusEl.classList.remove('syncing', 'error');
            }
        }

        function loadData() {
            const savedTheme = localStorage.getItem('theme') || 'dark';
            
            if (savedTheme === 'light') {
                document.body.classList.add('light-mode');
                document.getElementById('themeToggleBtn').textContent = '‚òÄÔ∏è';
            }
            
            loadFromFirebase();
        }

        async function loadFromFirebase() {
            try {
                setSyncStatus('üîÑ', 'Naƒç√≠t√°n√≠ z Firebase...', false);
                isLoadingFromFirebase = true;
                
                const { collection, getDocs, onSnapshot } = window.firestoreModules;
                
                // Naƒçten√≠ pozn√°mek
                const notesSnapshot = await getDocs(collection(window.db, 'notes'));
                notes = notesSnapshot.docs.map(doc => ({
                    id: doc.id,
                    firestoreId: doc.id,
                    ...doc.data()
                }));
                
                // Naƒçten√≠ projekt≈Ø
                const projectsSnapshot = await getDocs(collection(window.db, 'projects'));
                projects = projectsSnapshot.docs.map(doc => ({
                    id: doc.id,
                    firestoreId: doc.id,
                    ...doc.data()
                }));
                
                renderNotes();
                renderProjects();
                
                isLoadingFromFirebase = false;
                setSyncStatus('‚úÖ', 'Synchronizov√°no', false);
                
                // Real-time synchronizace
                onSnapshot(collection(window.db, 'notes'), (snapshot) => {
                    if (!isLoadingFromFirebase) {
                        snapshot.docChanges().forEach((change) => {
                            if (change.type === 'added' || change.type === 'modified') {
                                const data = { firestoreId: change.doc.id, id: change.doc.id, ...change.doc.data() };
                                const index = notes.findIndex(n => n.firestoreId === change.doc.id);
                                if (index >= 0) {
                                    notes[index] = data;
                                } else {
                                    notes.push(data);
                                }
                            } else if (change.type === 'removed') {
                                notes = notes.filter(n => n.firestoreId !== change.doc.id);
                            }
                        });
                        renderNotes();
                        renderProjects();
                    }
                });
                
                onSnapshot(collection(window.db, 'projects'), (snapshot) => {
                    if (!isLoadingFromFirebase) {
                        snapshot.docChanges().forEach((change) => {
                            if (change.type === 'added' || change.type === 'modified') {
                                const data = { firestoreId: change.doc.id, id: change.doc.id, ...change.doc.data() };
                                const index = projects.findIndex(p => p.firestoreId === change.doc.id);
                                if (index >= 0) {
                                    projects[index] = data;
                                } else {
                                    projects.push(data);
                                }
                            } else if (change.type === 'removed') {
                                projects = projects.filter(p => p.firestoreId !== change.doc.id);
                            }
                        });
                        renderProjects();
                    }
                });
                
            } catch (error) {
                console.error('Chyba p≈ôi naƒç√≠t√°n√≠ z Firebase:', error);
                setSyncStatus('‚ùå', 'Chyba p≈ôipojen√≠', true);
            }
        }

        async function saveToFirebase(type, data) {
            try {
                setSyncStatus('üîÑ', 'Ukl√°d√°n√≠...', false);
                
                const { collection, addDoc, updateDoc, doc } = window.firestoreModules;
                
                if (data.firestoreId) {
                    // Aktualizace existuj√≠c√≠ho dokumentu
                    const docRef = doc(window.db, type, data.firestoreId);
                    const { firestoreId, ...dataToSave } = data;
                    await updateDoc(docRef, dataToSave);
                } else {
                    // Vytvo≈ôen√≠ nov√©ho dokumentu
                    const { firestoreId, ...dataToSave } = data;
                    const docRef = await addDoc(collection(window.db, type), dataToSave);
                    data.firestoreId = docRef.id;
                    data.id = docRef.id;
                }
                
                setSyncStatus('‚úÖ', 'Ulo≈æeno', false);
                setTimeout(() => setSyncStatus('‚òÅÔ∏è', 'Synchronizov√°no', false), 2000);
            } catch (error) {
                console.error('Chyba p≈ôi ukl√°d√°n√≠ do Firebase:', error);
                setSyncStatus('‚ùå', 'Chyba ukl√°d√°n√≠', true);
            }
        }

        async function deleteFromFirebase(type, firestoreId) {
            try {
                setSyncStatus('üîÑ', 'Maz√°n√≠...', false);
                
                const { deleteDoc, doc } = window.firestoreModules;
                await deleteDoc(doc(window.db, type, firestoreId));
                
                setSyncStatus('‚úÖ', 'Smaz√°no', false);
                setTimeout(() => setSyncStatus('‚òÅÔ∏è', 'Synchronizov√°no', false), 2000);
            } catch (error) {
                console.error('Chyba p≈ôi maz√°n√≠ z Firebase:', error);
                setSyncStatus('‚ùå', 'Chyba maz√°n√≠', true);
            }
        }

        function showNewNoteModal() {
            const projectSelect = document.getElementById('newNoteProject');
            projectSelect.innerHTML = '<option value="">≈Ω√°dn√Ω projekt (voln√° pozn√°mka)</option>' +
                projects.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
            
            document.getElementById('newNoteModal').classList.add('active');
            document.getElementById('newNoteName').value = '';
            document.getElementById('newNoteName').focus();
        }

        function showNewProjectModal() {
            document.getElementById('newProjectModal').classList.add('active');
            document.getElementById('newProjectName').value = '';
            document.getElementById('newProjectName').focus();
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        function createNote() {
            const name = document.getElementById('newNoteName').value.trim();
            if (!name) return;

            const projectId = document.getElementById('newNoteProject').value;

            const note = {
                id: Date.now().toString(),
                name: name,
                title: '',
                content: '',
                projectId: projectId || null,
                created: new Date().toISOString()
            };

            notes.push(note);
            saveToFirebase('notes', note);
            renderNotes();
            renderProjects();
            closeModal('newNoteModal');
            openNote(note.id);
        }

        function createProject() {
            const name = document.getElementById('newProjectName').value.trim();
            if (!name) return;

            const project = {
                id: Date.now().toString(),
                name: name,
                expanded: true
            };

            projects.push(project);
            saveToFirebase('projects', project);
            renderProjects();
            closeModal('newProjectModal');
        }

        function deleteNote(id, event) {
            event.stopPropagation();
            if (confirm('Opravdu chcete smazat tuto pozn√°mku?')) {
                const note = notes.find(n => n.id === id);
                if (note && note.firestoreId) {
                    deleteFromFirebase('notes', note.firestoreId);
                }
                notes = notes.filter(n => n.id !== id);
                if (currentNote && currentNote.id === id) {
                    currentNote = null;
                    showEmptyState();
                }
                renderNotes();
                renderProjects();
            }
        }

        function deleteProject(id, event) {
            event.stopPropagation();
            if (confirm('Opravdu chcete smazat tento projekt? Pozn√°mky v projektu nebudou smaz√°ny.')) {
                const project = projects.find(p => p.id === id);
                if (project && project.firestoreId) {
                    deleteFromFirebase('projects', project.firestoreId);
                }
                projects = projects.filter(p => p.id !== id);
                notes.forEach(note => {
                    if (note.projectId === id) {
                        note.projectId = null;
                        if (note.firestoreId) {
                            saveToFirebase('notes', note);
                        }
                    }
                });
                renderNotes();
                renderProjects();
            }
        }

        function renderNotes() {
            const notesList = document.getElementById('notesList');
            const unassignedNotes = notes.filter(note => !note.projectId);
            
            notesList.innerHTML = unassignedNotes.map(note => `
                <div class="nav-item ${currentNote && currentNote.id === note.id ? 'active' : ''}"onclick="openNote('${note.id}')"
>
                    <span>${note.name || 'Bez n√°zvu'}</span>
                    <button class="delete-btn" onclick="deleteNote('${note.id}', event)"
>√ó</button>
                </div>
            `).join('');
        }

        function renderProjects() {
            const projectsList = document.getElementById('projectsList');
            
           projectsList.innerHTML = projects.map(project => {
    const projectNotes = notes.filter(note => note.projectId == project.id);
    return `
        <div class="nav-item" onclick="toggleProject('${project.id}', event)">
            <span>${project.expanded ? '‚ñº' : '‚ñ∂'} ${project.name}</span>
            <button class="delete-btn" onclick="deleteProject('${project.id}', event)">√ó</button>
        </div>
        ${project.expanded ? projectNotes.map(note => `
            <div class="nav-item project ${currentNote && currentNote.id === note.id ? 'active' : ''}" onclick="openNote('${note.id}')">
                <span>${note.name || 'Bez n√°zvu'}</span>
                <button class="delete-btn" onclick="deleteNote('${note.id}', event)">√ó</button>
            </div>
        `).join('') : ''}
    `;
}).join('');

        }

        function toggleProject(id, event) {
            if (event && event.target.classList.contains('delete-btn')) {
                return;
            }
            
            const project = projects.find(p => p.id === id);
            if (project) {
                project.expanded = !project.expanded;
                if (project.firestoreId) {
                    saveToFirebase('projects', project);
                }
                renderProjects();
            }
        }

        function openNote(id) {
            const note = notes.find(n => n.id === id);
            if (!note) return;

            currentNote = note;
            document.getElementById('emptyState').style.display = 'none';
            document.getElementById('editor').style.display = 'block';
            document.getElementById('exportBtn').style.display = 'block';
            document.getElementById('contentTitle').textContent = note.name || 'Bez n√°zvu';
            document.getElementById('noteTitle').value = note.title || '';
            document.getElementById('noteContent').innerHTML = note.content || '';
            
            renderNotes();
            renderProjects();
        }

        function showEmptyState() {
            document.getElementById('emptyState').style.display = 'block';
            document.getElementById('editor').style.display = 'none';
            document.getElementById('exportBtn').style.display = 'none';
            document.getElementById('contentTitle').textContent = 'Vyberte pozn√°mku';
        }

        function autoSave() {
            if (!currentNote) return;

            const title = document.getElementById('noteTitle').value;
            const content = document.getElementById('noteContent').innerHTML;

            currentNote.title = title;
            currentNote.content = content;

            if (title && currentNote.name === '') {
                currentNote.name = title.substring(0, 50);
                document.getElementById('contentTitle').textContent = currentNote.name;
            }

            if (currentNote.firestoreId) {
                saveToFirebase('notes', currentNote);
            }
            renderNotes();
            renderProjects();
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const toggleBtn = document.getElementById('toggleSidebarBtn');
            const themeBtn = document.getElementById('themeToggleBtn');
            
            sidebar.classList.toggle('collapsed');
            toggleBtn.classList.toggle('collapsed');
            themeBtn.classList.toggle('collapsed');
            toggleBtn.textContent = sidebar.classList.contains('collapsed') ? '‚ò∞' : '‚úï';
        }

        function toggleTheme() {
            const body = document.body;
            const themeBtn = document.getElementById('themeToggleBtn');
            
            body.classList.toggle('light-mode');
            
            if (body.classList.contains('light-mode')) {
                themeBtn.textContent = '‚òÄÔ∏è';
                localStorage.setItem('theme', 'light');
            } else {
                themeBtn.textContent = 'üåô';
                localStorage.setItem('theme', 'dark');
            }
        }

        async function exportToPDF() {
            if (!currentNote) return;
            
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF('p', 'mm', 'a4');
            
            const title = currentNote.title || currentNote.name || 'Pozn√°mka';
            const content = document.getElementById('noteContent').cloneNode(true);
            
            const tempDiv = document.createElement('div');
            tempDiv.style.position = 'absolute';
            tempDiv.style.left = '-9999px';
            tempDiv.style.width = '210mm';
            tempDiv.style.padding = '20mm';
            tempDiv.style.backgroundColor = 'white';
            tempDiv.style.color = '#000000';
            tempDiv.style.fontSize = '12pt';
            tempDiv.style.fontFamily = 'Arial, sans-serif';
            tempDiv.style.lineHeight = '1.6';
            
            const titleEl = document.createElement('h1');
            titleEl.textContent = title;
            titleEl.style.fontSize = '18pt';
            titleEl.style.marginBottom = '20px';
            titleEl.style.color = '#000000';
            titleEl.style.fontWeight = 'bold';
            
            const contentClone = content.cloneNode(true);
            contentClone.style.color = '#000000';
            
            const allElements = contentClone.querySelectorAll('*');
            allElements.forEach(el => {
                if (!el.style.color || el.style.color === 'rgb(224, 224, 224)' || el.style.color === '#e0e0e0') {
                    el.style.color = '#000000';
                }
            });
            
            tempDiv.appendChild(titleEl);
            tempDiv.appendChild(contentClone);
            
            document.body.appendChild(tempDiv);
            
            try {
                const canvas = await html2canvas(tempDiv, {
                    scale: 2,
                    backgroundColor: '#ffffff',
                    logging: false
                });
                
                const imgData = canvas.toDataURL('image/png');
                const imgWidth = 210 - 40;
                const imgHeight = (canvas.height * imgWidth) / canvas.width;
                
                let heightLeft = imgHeight;
                let position = 0;
                
                pdf.addImage(imgData, 'PNG', 20, 20, imgWidth, imgHeight);
                heightLeft -= 277;
                
                while (heightLeft > 0) {
                    position = heightLeft - imgHeight;
                    pdf.addPage();
                    pdf.addImage(imgData, 'PNG', 20, position + 20, imgWidth, imgHeight);
                    heightLeft -= 277;
                }
                
                pdf.save(`${title}.pdf`);
            } catch (error) {
                console.error('Chyba p≈ôi exportu:', error);
                alert('Nepoda≈ôilo se exportovat pozn√°mku do PDF');
            } finally {
                document.body.removeChild(tempDiv);
            }
        }

        function getStorageInfo() {
            console.log('üìä Informace o √∫lo≈æi≈°ti:');
            console.log('Poƒçet pozn√°mek:', notes.length);
            console.log('Poƒçet projekt≈Ø:', projects.length);
            console.log('Firebase je aktivn√≠ - data jsou v cloudu!');
            console.log('Kapacita: 1 GB zdarma (pak $0.18/GB)');
        }

        function toggleBold() {
            document.execCommand('bold', false, null);
        }

        function toggleItalic() {
            document.execCommand('italic', false, null);
        }

        function toggleUnderline() {
            document.execCommand('underline', false, null);
        }

        function changeFontSize(size) {
            const content = document.getElementById('noteContent');
            content.style.fontSize = size + 'px';
        }

        function insertImage(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const img = document.createElement('img');
                img.src = e.target.result;
                
                const content = document.getElementById('noteContent');
                content.focus();
                
                const selection = window.getSelection();
                if (selection.rangeCount > 0) {
                    const range = selection.getRangeAt(0);
                    range.insertNode(img);
                    range.collapse(false);
                } else {
                    content.appendChild(img);
                }
                
                autoSave();
            };
            reader.readAsDataURL(file);
            
            event.target.value = '';
        }

        function searchNotes(query) {
            const lowerQuery = query.toLowerCase();
            const notesList = document.getElementById('notesList');
            const allNotes = notes.filter(note => !note.projectId);
            
            const filtered = allNotes.filter(note => 
                note.name.toLowerCase().includes(lowerQuery) ||
                (note.title && note.title.toLowerCase().includes(lowerQuery)) ||
                (note.content && note.content.toLowerCase().includes(lowerQuery))
            );

            notesList.innerHTML = filtered.map(note => `
                <div class="nav-item ${currentNote && currentNote.id === note.id ? 'active' : ''}" onclick="openNote(${note.id})">
                    <span>${note.name || 'Bez n√°zvu'}</span>
                    <button class="delete-btn" onclick="deleteNote(${note.id}, event)">√ó</button>
                </div>
            `).join('');
        }

        document.getElementById('noteTitle').addEventListener('input', () => {
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(autoSave, 500);
        });

        document.getElementById('noteContent').addEventListener('input', () => {
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(autoSave, 500);
        });

        document.getElementById('noteContent').addEventListener('paste', (e) => {
            const items = e.clipboardData.items;
            for (let i = 0; i < items.length; i++) {
                if (items[i].type.indexOf('image') !== -1) {
                    e.preventDefault();
                    const blob = items[i].getAsFile();
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        const img = document.createElement('img');
                        img.src = event.target.result;
                        document.execCommand('insertHTML', false, img.outerHTML);
                        setTimeout(autoSave, 100);
                    };
                    reader.readAsDataURL(blob);
                    break;
                }
            }
        });

        document.getElementById('newNoteName').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') createNote();
        });

        document.getElementById('newProjectName').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') createProject();
        });

        loadData();
        getStorageInfo();
    </script>
</body>
</html>
